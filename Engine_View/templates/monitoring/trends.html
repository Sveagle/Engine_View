{% extends 'base.html' %}
{% load static %}

{% block title %}–ì—Ä–∞—Ñ–∏–∫–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ - Engine View{% endblock %}

{% block extra_head %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .chart-container {
        position: relative;
        height: 400px;
        width: 100%;
        margin-bottom: 2rem;
    }
    .param-card {
        transition: all 0.3s ease;
    }
    .param-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- –•–ª–µ–±–Ω—ã–µ –∫—Ä–æ—à–∫–∏ -->
        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'pages:home' %}">–ì–ª–∞–≤–Ω–∞—è</a></li>
                <li class="breadcrumb-item"><a href="{% url 'monitoring:measurement_list' %}">–î–∞–Ω–Ω—ã–µ</a></li>
                <li class="breadcrumb-item active">–ì—Ä–∞—Ñ–∏–∫–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤</li>
            </ol>
        </nav>

        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>üìà –ì—Ä–∞—Ñ–∏–∫–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤</h1>
            <a href="{% url 'monitoring:measurement_list' %}" class="btn btn-outline-secondary">
                ‚Üê –ù–∞–∑–∞–¥ –∫ –¥–∞–Ω–Ω—ã–º
            </a>
        </div>

        <!-- –§–∏–ª—å—Ç—Ä—ã -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">üîç –§–∏–ª—å—Ç—Ä—ã –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤</h5>
            </div>
            <div class="card-body">
                <form method="get" class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">–°—É–¥–Ω–æ</label>
                        <select name="vessel" class="form-select">
                            <option value="">–í—Å–µ —Å—É–¥–∞</option>
                            {% for vessel in vessels %}
                            <option value="{{ vessel.id }}" {% if request.GET.vessel == vessel.id|stringformat:"s" %}selected{% endif %}>
                                {{ vessel.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">–î–≤–∏–≥–∞—Ç–µ–ª—å</label>
                        <select name="engine" class="form-select">
                            <option value="">–í—Å–µ –¥–≤–∏–≥–∞—Ç–µ–ª–∏</option>
                            {% for engine in engines %}
                            <option value="{{ engine.id }}" {% if request.GET.engine == engine.id|stringformat:"s" %}selected{% endif %}>
                                {{ engine.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">–î–∞—Ç–∞ —Å</label>
                        <input type="date" name="date_from" class="form-control" value="{{ request.GET.date_from }}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">–î–∞—Ç–∞ –ø–æ</label>
                        <input type="date" name="date_to" class="form-control" value="{{ request.GET.date_to }}">
                    </div>
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
                        <a href="{% url 'monitoring:trends' %}" class="btn btn-outline-secondary">–°–±—Ä–æ—Å–∏—Ç—å</a>
                    </div>
                </form>
            </div>
        </div>

        <!-- –ì—Ä–∞—Ñ–∏–∫–∏ -->
        <div class="row">
            <div class="col-lg-6 mb-4">
                <div class="card param-card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">üå°Ô∏è –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="temperatureChart"></canvas>
                        </div>
                        <div class="mt-3">
                            <small class="text-muted">–î–∏–Ω–∞–º–∏–∫–∞ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-6 mb-4">
                <div class="card param-card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">üìä –î–∞–≤–ª–µ–Ω–∏–µ</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="pressureChart"></canvas>
                        </div>
                        <div class="mt-3">
                            <small class="text-muted">–î–∏–Ω–∞–º–∏–∫–∞ –¥–∞–≤–ª–µ–Ω–∏—è –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-6 mb-4">
                <div class="card param-card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">üîÑ –û–±–æ—Ä–æ—Ç—ã –¥–≤–∏–≥–∞—Ç–µ–ª—è</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="rpmChart"></canvas>
                        </div>
                        <div class="mt-3">
                            <small class="text-muted">–î–∏–Ω–∞–º–∏–∫–∞ –æ–±–æ—Ä–æ—Ç–æ–≤ –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-6 mb-4">
                <div class="card param-card">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">‚õΩ –†–∞—Å—Ö–æ–¥ —Ç–æ–ø–ª–∏–≤–∞</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="fuelChart"></canvas>
                        </div>
                        <div class="mt-3">
                            <small class="text-muted">–î–∏–Ω–∞–º–∏–∫–∞ —Ä–∞—Å—Ö–æ–¥–∞ —Ç–æ–ø–ª–∏–≤–∞ –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º –¥–∞–Ω–Ω—ã–º</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3 mb-3">
                        <div class="border rounded p-3">
                            <h4 class="text-primary">{{ measurements_count }}</h4>
                            <p class="mb-0 text-muted">–í—Å–µ–≥–æ –∑–∞–º–µ—Ä–æ–≤</p>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="border rounded p-3">
                            <h4 class="text-success">{{ date_range }}</h4>
                            <p class="mb-0 text-muted">–ü–µ—Ä–∏–æ–¥</p>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="border rounded p-3">
                            <h4 class="text-info">{{ vessels_count }}</h4>
                            <p class="mb-0 text-muted">–°—É–¥–æ–≤</p>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="border rounded p-3">
                            <h4 class="text-warning">{{ engines_count }}</h4>
                            <p class="mb-0 text-muted">–î–≤–∏–≥–∞—Ç–µ–ª–µ–π</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ Django –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    const chartData = {{ chart_data_json|safe }};
    
    const chartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: false,
                grid: { color: 'rgba(0,0,0,0.1)' }
            },
            x: {
                grid: { color: 'rgba(0,0,0,0.1)' },
                ticks: {
                    maxTicksLimit: 10, // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Ç–æ–∫
                    callback: function(value) {
                        return this.getLabelForValue(value).substring(0, 10); // –¢–æ–ª—å–∫–æ –¥–∞—Ç–∞
                    }
                }
            }
        },
        plugins: {
            legend: { position: 'top' },
            tooltip: {
                mode: 'index',
                intersect: false,
                callbacks: {
                    title: function(context) {
                        return chartData.labels[context[0].dataIndex];
                    }
                }
            }
        }
    };

    // –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞
    new Chart(document.getElementById('temperatureChart'), {
        type: 'line',
        data: {
            labels: chartData.labels,
            datasets: [{
                label: '–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ (¬∞C)',
                data: chartData.temperature,
                borderColor: 'rgb(255, 99, 132)',
                backgroundColor: 'rgba(255, 99, 132, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: chartOptions
    });

    // –î–∞–≤–ª–µ–Ω–∏–µ
    new Chart(document.getElementById('pressureChart'), {
        type: 'line',
        data: {
            labels: chartData.labels,
            datasets: [{
                label: '–î–∞–≤–ª–µ–Ω–∏–µ (–±–∞—Ä)',
                data: chartData.pressure,
                borderColor: 'rgb(54, 162, 235)',
                backgroundColor: 'rgba(54, 162, 235, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: chartOptions
    });

    // –û–±–æ—Ä–æ—Ç—ã
    new Chart(document.getElementById('rpmChart'), {
        type: 'line',
        data: {
            labels: chartData.labels,
            datasets: [{
                label: '–û–±–æ—Ä–æ—Ç—ã (–æ–±/–º–∏–Ω)',
                data: chartData.rpm,
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: chartOptions
    });

    // –†–∞—Å—Ö–æ–¥ —Ç–æ–ø–ª–∏–≤–∞
    new Chart(document.getElementById('fuelChart'), {
        type: 'line',
        data: {
            labels: chartData.labels,
            datasets: [{
                label: '–†–∞—Å—Ö–æ–¥ —Ç–æ–ø–ª–∏–≤–∞ (–ª/—á)',
                data: chartData.fuel_consumption,
                borderColor: 'rgb(255, 159, 64)',
                backgroundColor: 'rgba(255, 159, 64, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: chartOptions
    });

    // –£–±–∏—Ä–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –æ –∑–∞–≥—Ä—É–∑–∫–µ
    document.querySelectorAll('.chart-container > div').forEach(el => {
        if (el.textContent.includes('–ó–∞–≥—Ä—É–∑–∫–∞')) {
            el.remove();
        }
    });
});
</script>
{% endblock %}