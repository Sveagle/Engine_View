{% extends 'base.html' %}
{% load static %}

{% block title %}–ò–º–ø–æ—Ä—Ç CSV - Engine View{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">üì§ –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –∏–∑ CSV</h4>
            </div>
            <div class="card-body">
                
                <!-- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è -->
                <div class="alert alert-info">
                    <h5>üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∏–º–ø–æ—Ä—Ç—É:</h5>
                    <ol class="mb-0">
                        <li>–ü–æ–¥–≥–æ—Ç–æ–≤—å—Ç–µ CSV —Ñ–∞–π–ª —Å –¥–∞–Ω–Ω—ã–º–∏</li>
                        <li>–ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–æ–ª–∂–Ω–∞ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∫–æ–ª–æ–Ω–æ–∫</li>
                        <li>–û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è –∫–æ–ª–æ–Ω–∫–∞: <code>timestamp</code> (–≤—Ä–µ–º—è –∑–∞–º–µ—Ä–∞)</li>
                        <li>–û—Å—Ç–∞–ª—å–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –¥–æ–ª–∂–Ω—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –∫–æ–¥–∞–º –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤</li>
                    </ol>
                </div>

                <!-- –§–æ—Ä–º–∞ –∏–º–ø–æ—Ä—Ç–∞ -->
                <form method="post" enctype="multipart/form-data" id="import-form">
                    {% csrf_token %}
                    
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ form.vessel.id_for_label }}">–°—É–¥–Ω–æ *</label>
                                {{ form.vessel }}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ form.engine.id_for_label }}">–î–≤–∏–≥–∞—Ç–µ–ª—å *</label>
                                {{ form.engine }}
                            </div>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ form.csv_file.id_for_label }}">CSV —Ñ–∞–π–ª *</label>
                                {{ form.csv_file }}
                                <small class="form-text text-muted">{{ form.csv_file.help_text }}</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="{{ form.delimiter.id_for_label }}">–†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å</label>
                                {{ form.delimiter }}
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="{{ form.timestamp_format.id_for_label }}">–§–æ—Ä–º–∞—Ç –¥–∞—Ç—ã</label>
                                {{ form.timestamp_format }}
                            </div>
                        </div>
                    </div>

                    <!-- –ö–Ω–æ–ø–∫–∏ -->
                    <div class="row">
                        <div class="col-12">
                            <button type="submit" class="btn btn-success btn-lg">
                                üì§ –ù–∞—á–∞—Ç—å –∏–º–ø–æ—Ä—Ç
                            </button>
                            <a href="{% url 'monitoring:download_csv_template' %}" class="btn btn-outline-primary btn-lg">
                                üì• –°–∫–∞—á–∞—Ç—å —à–∞–±–ª–æ–Ω
                            </a>
                            <a href="{% url 'monitoring:measurement_list' %}" class="btn btn-secondary btn-lg">
                                ‚Üê –ù–∞–∑–∞–¥
                            </a>
                        </div>
                    </div>
                </form>

                <div class="mt-4">
                    <a href="{% url 'monitoring:parameter_management' %}" class="btn btn-outline-primary">
                        ‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
                    </a>
                </div>
                {% if created_parameters %}
                <div class="mt-4">
                    <h5>‚úÖ –°–æ–∑–¥–∞–Ω—ã –Ω–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:</h5>
                    <ul>
                        {% for param in created_parameters %}
                        <li>{{ param.name }} ({{ param.code }}) - {{ param.unit|default:"—Ç–µ–∫—Å—Ç–æ–≤—ã–π" }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
                <!-- –°–ø–∏—Å–æ–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ -->
                <div class="mt-5">
                    <h5>üìä –î–æ—Å—Ç—É–ø–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞:</h5>
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered">
                            <thead>
                                <tr>
                                    <th>–ö–æ–¥ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞</th>
                                    <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                    <th>–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è</th>
                                    <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for param in parameter_types %}
                                <tr>
                                    <td><code>{{ param.code }}</code></td>
                                    <td>{{ param.name }}</td>
                                    <td>{{ param.unit }}</td>
                                    <td>{{ param.description|default:"-" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- –û—à–∏–±–∫–∏ –∏–º–ø–æ—Ä—Ç–∞ -->
                {% if import_errors %}
                <div class="mt-4">
                    <h5 class="text-danger">‚ùå –û—à–∏–±–∫–∏ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ:</h5>
                    <div class="alert alert-warning">
                        <div style="max-height: 300px; overflow-y: auto;">
                            {% for error in import_errors %}
                            <div class="mb-1">{{ error }}</div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}

            </div>
        </div>
    </div>
</div>

<script>
// –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –¥–≤–∏–≥–∞—Ç–µ–ª–µ–π –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Å—É–¥–Ω–∞
document.getElementById('id_vessel').addEventListener('change', function() {
    const form = document.getElementById('import-form');
    form.submit(); // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –¥–≤–∏–≥–∞—Ç–µ–ª–µ–π
});

// –ü–æ–∫–∞–∑ –ø—Ä–µ–≤—å—é —Ñ–∞–π–ª–∞
document.getElementById('id_csv_file').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const preview = e.target.result.split('\n').slice(0, 5).join('\n');
            // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–≤—å—é —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ —Ñ–∞–π–ª–∞
        };
        reader.readAsText(file);
    }
});
</script>
{% endblock %}