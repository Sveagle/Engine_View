{% extends 'base.html' %}
{% load static %}

{% block title %}–ó–∞–º–µ—Ä—ã - Engine View{% endblock %}

{% block content %}
<div class="row mb-4">
	<div class="col-12">
			<div class="d-flex justify-content-between align-items-center">
					<h2>üìã –í—Å–µ –∑–∞–º–µ—Ä—ã</h2>
					<a href="{% url 'monitoring:create_measurement' %}" class="btn btn-success">
							‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—Ä
					</a>
			</div>
	</div>
</div>

<!-- –§–∏–ª—å—Ç—Ä—ã -->
<div class="row mb-4">
	<div class="col-12">
			<div class="card">
					<div class="card-body">
							<form method="get" class="row g-3">
									<div class="col-md-3">
											<label class="form-label">–°—É–¥–Ω–æ</label>
											{{ filter_form.vessel }}
									</div>
									<div class="col-md-3">
											<label class="form-label">–î–≤–∏–≥–∞—Ç–µ–ª—å</label>
											{{ filter_form.engine }}
									</div>
									<div class="col-md-2">
											<label class="form-label">–° –¥–∞—Ç—ã</label>
											{{ filter_form.date_from }}
									</div>
									<div class="col-md-2">
											<label class="form-label">–ü–æ –¥–∞—Ç—É</label>
											{{ filter_form.date_to }}
									</div>
									<div class="col-md-2">
											<label class="form-label">&nbsp;</label>
											<button type="submit" class="btn btn-primary w-100">üîç –ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
									</div>
							</form>
					</div>
			</div>
	</div>
</div>

<!-- –¢–∞–±–ª–∏—Ü–∞ –∑–∞–º–µ—Ä–æ–≤ -->
<div class="row">
	<div class="col-12">
			<div class="card">
					<div class="card-body">
							{% if measurements %}
							<div class="table-responsive">
									<table class="table table-striped table-hover">
											<thead>
													<tr>
															<th>–í—Ä–µ–º—è</th>
															<th>–°—É–¥–Ω–æ</th>
															<th>–î–≤–∏–≥–∞—Ç–µ–ª—å</th>
															<th>–û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</th>
															<th>–ö—Ç–æ –¥–æ–±–∞–≤–∏–ª</th>
															<th>–î–µ–π—Å—Ç–≤–∏—è</th>
													</tr>
											</thead>
											<tbody>
													{% for measurement in measurements %}
													<tr>
															<td>
																	<strong>{{ measurement.timestamp|date:"d.m.Y" }}</strong><br>
																	<small class="text-muted">{{ measurement.timestamp|date:"H:i" }}</small>
															</td>
															<td>{{ measurement.engine.vessel.name }}</td>
															<td>{{ measurement.engine.name }}</td>
															<td>
																	{% with param_values=measurement.parameter_values.all|slice:":3" %}
																			{% for pv in param_values %}
																					<span class="badge bg-light text-dark me-1">
																							{{ pv.parameter_type.name }}: {{ pv.value }} {{ pv.parameter_type.unit }}
																					</span>
																			{% endfor %}
																			{% if measurement.parameter_values.count > 3 %}
																					<span class="badge bg-secondary">+{{ measurement.parameter_values.count|add:"-3" }}</span>
																			{% endif %}
																	{% endwith %}
															</td>
															<td>
																	{% if measurement.created_by %}
																			{{ measurement.created_by.username }}
																	{% else %}
																			<span class="text-muted">–°–∏—Å—Ç–µ–º–∞</span>
																	{% endif %}
															</td>
															<td>
																	<div class="btn-group">
																			<a href="{% url 'monitoring:measurement_detail' measurement.pk %}" 
																			class="btn btn-sm btn-outline-primary">
																					üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä
																			</a>
																			{% if user.is_staff %}
																			<a href="{% url 'monitoring:delete_measurement' measurement.pk %}" 
																			class="btn btn-sm btn-outline-danger"
																			onclick="return confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∑–∞–º–µ—Ä?')">
																					üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
																			</a>
																			{% endif %}
																	</div>
															</td>
													</tr>
													{% endfor %}
											</tbody>
									</table>
							</div>

							<!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
							{% if is_paginated %}
							<nav aria-label="Page navigation">
									<ul class="pagination justify-content-center">
											{% if page_obj.has_previous %}
											<li class="page-item">
													<a class="page-link" href="?page={{ page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">‚Üê</a>
											</li>
											{% endif %}
											
											{% for num in page_obj.paginator.page_range %}
													{% if page_obj.number == num %}
													<li class="page-item active"><span class="page-link">{{ num }}</span></li>
													{% else %}
													<li class="page-item"><a class="page-link" href="?page={{ num }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{{ num }}</a></li>
													{% endif %}
											{% endfor %}
											
											{% if page_obj.has_next %}
											<li class="page-item">
													<a class="page-link" href="?page={{ page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">‚Üí</a>
											</li>
											{% endif %}
									</ul>
							</nav>
							{% endif %}

							{% else %}
							<div class="text-center py-5">
									<h4>üì≠ –ó–∞–º–µ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h4>
									<p class="text-muted">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏</p>
									<a href="{% url 'monitoring:create_measurement' %}" class="btn btn-primary">
											‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤—ã–π –∑–∞–º–µ—Ä
									</a>
							</div>
							{% endif %}
					</div>
			</div>
	</div>
</div>
{% endblock %}